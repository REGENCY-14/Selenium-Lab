# Name of the workflow (appears in GitHub Actions tab)
name: CI

# Defines when the workflow should run
on:
  push:
    # Runs when code is pushed to these branches
    branches: ["main", "dev", "feature/**"]
  pull_request:
    # Runs when a pull request is opened or updated for these branches
    branches: ["main", "dev"]

# Defines jobs to execute
jobs:

  # Job name
  test:

    # Specifies the OS/environment to run on (Ubuntu Linux)
    runs-on: ubuntu-latest

    # Maximum time this job is allowed to run before timing out
    timeout-minutes: 30

    # Environment variables available to all steps in this job
    env:
      # Slack webhook URL stored securely in GitHub secrets
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      # Email recipient stored securely in GitHub secrets
      SMTP_TO: ${{ secrets.SMTP_TO }}

    # Steps executed in order
    steps:

      # Step 1: Checkout repository code
      - name: Checkout
        uses: actions/checkout@v4
        # Downloads your repository code into the runner

      # Step 2: Install Google Chrome browser
      - name: Set up Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          # Installs latest stable version of Chrome
          chrome-version: stable

      # Step 3: Install Java Development Kit (JDK)
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          # Uses Temurin distribution of Java
          distribution: "temurin"

          # Sets Java version to 21
          java-version: "21"

          # Enables caching of Maven dependencies to speed up builds
          cache: "maven"

      # Step 4: Run Selenium tests using Maven
      - name: Run tests
        id: test_step   # Unique ID used to reference this step later

        # Allows workflow to continue even if tests fail
        continue-on-error: true

        env:
          # Sets maximum memory allocation for Java
          MAVEN_OPTS: "-Xmx1g"

        run: |
          # Runs Maven tests in batch mode
          mvn -B -e -DtrimStackTrace=false test \
          -Dheadless=true \   # Runs Chrome in headless mode
          -Dsurefire.printSummary=true  # Prints test summary

      # Step 5: Upload test reports
      - name: Upload Surefire reports

        # Runs whether tests pass or fail
        if: always()

        continue-on-error: true

        uses: actions/upload-artifact@v4

        with:
          # Name of artifact
          name: surefire-reports

          # Path to test reports
          path: target/surefire-reports

      # Step 6: Collect test metadata (test results, commit info)
      - name: Collect test metadata
        id: test_meta

        # Always run this step
        if: always()

        continue-on-error: true

        env:
          # Gets result of test_step
          TEST_OUTCOME: ${{ steps.test_step.outcome }}

        run: |
          # Run Python script to extract test and commit information
          python - <<'PY'

          import datetime
          import glob
          import os
          import subprocess
          import xml.etree.ElementTree as ET

          # Function to run git commands
          def git(*args):
              return subprocess.check_output(["git", *args]).decode().strip()

          # Initialize counters
          total = failures = errors = skipped = 0

          # Loop through all test report XML files
          for path in glob.glob("target/surefire-reports/*.xml"):
              try:
                  root = ET.parse(path).getroot()

                  # Extract test statistics
                  total += int(root.attrib.get("tests", 0))
                  failures += int(root.attrib.get("failures", 0))
                  errors += int(root.attrib.get("errors", 0))
                  skipped += int(root.attrib.get("skipped", 0))
              except Exception:
                  continue

          # Calculate passed and failed tests
          failed = failures + errors
          passed = max(total - failed - skipped, 0)

          # Determine test status
          outcome = os.environ.get("TEST_OUTCOME", "")
          status = "PASSED" if outcome == "success" else "FAILED" if outcome == "failure" else "UNKNOWN"

          # Get current timestamp
          timestamp = datetime.datetime.utcnow().replace(microsecond=0).isoformat() + "Z"

          # Get commit information
          commit_sha = git("rev-parse", "HEAD")
          commit_author = git("log", "-1", "--pretty=%an")
          commit_message = git("log", "-1", "--pretty=%s")

          # Write outputs for use in later steps
          out_path = os.environ.get("GITHUB_OUTPUT")

          with open(out_path, "a", encoding="utf-8") as f:
              f.write(f"tests_passed={passed}\n")
              f.write(f"tests_failed={failed}\n")
              f.write(f"tests_status={status}\n")
              f.write(f"timestamp={timestamp}\n")
              f.write(f"commit_sha={commit_sha}\n")
              f.write(f"commit_author={commit_author}\n")
              f.write(f"commit_message={commit_message}\n")

          PY

      # Step 7: Fail the job if tests failed
      - name: Fail job if tests failed

        # Runs only if test step failed
        if: steps.test_step.outcome == 'failure'

        # Forces job to fail
        run: exit 1

      # Step 8: Send Slack notification on success
      - name: Slack notification on success

        # Runs only if workflow succeeds and webhook exists
        if: success() && env.SLACK_WEBHOOK_URL != ''

        continue-on-error: true

        uses: slackapi/slack-github-action@v1.27.0

        with:
          # Slack message content
          payload: |
            {
              "text": "✅ CI Success\nRepository: ${{ github.repository }}\nRepository URL: ${{ github.server_url }}/${{ github.repository }}\nAuthor: ${{ github.event.pull_request.user.login || github.actor }}\nSource Branch: ${{ github.head_ref || github.ref_name }}\nTarget Branch: ${{ github.base_ref || github.ref_name }}\nCommit Message: ${{ steps.test_meta.outputs.commit_message }}\nCommit SHA: ${{ steps.test_meta.outputs.commit_sha }}\nCommit Author: ${{ steps.test_meta.outputs.commit_author }}\nTests Passed: ${{ steps.test_meta.outputs.tests_passed }}\nTests Failed: ${{ steps.test_meta.outputs.tests_failed }}\nOverall Test Status: ${{ steps.test_meta.outputs.tests_status }}\nWorkflow Run URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\nTimestamp: ${{ steps.test_meta.outputs.timestamp }}"
            }

      # Step 9: Send Slack notification on failure
      - name: Slack notification on failure

        # Runs if workflow fails
        if: always() && failure() && env.SLACK_WEBHOOK_URL != ''

        continue-on-error: true

        uses: slackapi/slack-github-action@v1.27.0

        with:
          payload: |
            {
              "text": "❌ CI Failed\nRepository: ${{ github.repository }}\nRepository URL: ${{ github.server_url }}/${{ github.repository }}\nAuthor: ${{ github.event.pull_request.user.login || github.actor }}\nSource Branch: ${{ github.head_ref || github.ref_name }}\nTarget Branch: ${{ github.base_ref || github.ref_name }}\nCommit Message: ${{ steps.test_meta.outputs.commit_message }}\nCommit SHA: ${{ steps.test_meta.outputs.commit_sha }}\nCommit Author: ${{ steps.test_meta.outputs.commit_author }}\nTests Passed: ${{ steps.test_meta.outputs.tests_passed }}\nTests Failed: ${{ steps.test_meta.outputs.tests_failed }}\nOverall Test Status: ${{ steps.test_meta.outputs.tests_status }}\nWorkflow Run URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\nTimestamp: ${{ steps.test_meta.outputs.timestamp }}"
            }

      # Step 10: Send email notification on success
      - name: Email notification on success

        if: success() && env.SMTP_TO != ''

        continue-on-error: true

        uses: dawidd6/action-send-mail@v3

        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}

          subject: "CI Success"

          to: ${{ secrets.SMTP_TO }}

          from: selenium-lab-ci@github.com

          body: |
            CI Success
            Tests Passed: ${{ steps.test_meta.outputs.tests_passed }}

      # Step 11: Send email notification on failure
      - name: Email notification on failure

        if: always() && failure() && env.SMTP_TO != ''

        continue-on-error: true

        uses: dawidd6/action-send-mail@v3

        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}

          subject: "CI Failed"

          to: ${{ secrets.SMTP_TO }}

          from: selenium-lab-ci@github.com

          body: |
            CI Failed
            Tests Failed: ${{ steps.test_meta.outputs.tests_failed }}
